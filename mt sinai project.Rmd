
---
title: "<h1 style='margin-bottom: 10px; text-align: center;'>Examining Trends in Pediatric Healthcare Utilization</h1>"
subtitle: "<h3 style='margin-top: 5px; margin-bottom: 20px; text-align: center; font-style: italic;'>Data Analyst Candidate Assignment: CCHSR</h3>"
author: "<p style='margin-bottom: 5px; text-align: center;'>Laura Robles-Torres</p>"
date: "<p style='margin-bottom: 30px; text-align: center;'>February 18, 2025</p>"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Part 1: Trends in utilization of various healthcare services among children between 2015 and 2023

*The code below includes initial library loading, data importing, and reshaping for analysis.*
```{r install packages, message=FALSE, code_folding="hide"}
library(tidyverse)
library(tidyr)
library(readxl)
library(dbplyr)
library(stringr)
```

```{r import sheet 1, results='hide', code_folding="hide"}
utilization_data =
    readxl::read_excel("data.xlsx", sheet = "Sheet1")

head(utilization_data)
```

```{r payor groups, code_folding="hide"}
payor_data = utilization_data |>
  mutate(
    payor = ifelse(category %in% c("Medicaid", "Private Insurance"), category, NA)
  ) |> 
  fill(payor, .direction = "down") |> 
  filter(!category %in% c("Medicaid", "Private Insurance")) |> # Remove payor label rows that are empty 
  slice(1:8)

# Reshape data into long format
payor_data |>
  pivot_longer(cols = `2015`:`2023`, names_to = "year", values_to = "utilization") |>
  mutate(year = as.numeric(year)) |>
  select(year, payor, category, utilization) -> payor_data
```

### Utilization of different healthcare services between 2015 and 2023

Data collected group healthcare services by both **type of service** and **insurance payers**. Healthcare services are grouped in four different categories, listed below.  

- Primary Care Visits, well-child 
- Primary Care Visits, sick 
- Emergency Department Visits 
- Inpatient Days 

The insurance payers included are **Medicaid** and **Private insurance**. 

Between 2015 and 2023, several trends can be observed in healthcare utilization among races/ethnicities and different payers. 

#### By insurance payor
Before 2020, trends in ED visits, primary care sick visits, and inpatient days do not appear significantly different between the two payer groups. However, more primary care well-child visits were covered by private insurance than by Medicaid until 2020. Across all 4 types of services, there is an increase in Medicaid as the primary payer starting in 2020 with visits covered by private insurance remaining at a similar level. 

```{r plotting payor trends}
#Plot utilization of each service by payor
ggplot(payor_data, aes(x = year, y = utilization, color = payor)) +
  geom_line() +
  facet_wrap(~ category, scales = "fixed") +
  theme_minimal() +
  labs(title = "Healthcare Utilization Trends by Payor", x = "Year", y = "Utilization", color="Insurance Payer")
```

This could be a reflection of Medicaid expansion initiatives that took place in the wake of the COVID-19 pandemic starting in 2020. With more individuals qualifying for Medicaid, more individuals were able to access these 4 different types of healthcare services. 

#### By race/ethnicity
```{r race/ethn groups, code_folding="hide"}
#Clean data for racial group exploration
race_data = 
  utilization_data |>
  mutate(
    race = ifelse(category %in% c("Hispanic", "Non-Hispanic Black", "Non-Hispanic White"), category, NA)
  ) |> 
  fill(race, .direction = "down") |>  # Fill race downwards
  filter(!category %in% c("Hispanic", "Non-Hispanic Black", "Non-Hispanic White")) 

# Reshape data into long format
race_data |>
  pivot_longer(cols = `2015`:`2023`, names_to = "year", values_to = "utilization")|>
  mutate(year = as.numeric(year)) |>
  filter(!is.na(utilization)) |>
  filter(!is.na(race)) |>
  slice_tail(n=126) -> race_data
```

For both ED visits and for inpatient days, Hispanic and Non-Hispanic Black have a higher utilization than Non-Hispanic White children overall. Since 2020, a slight decrease in ED visits for both of these racial/ethnic groups can be observed. From 2015-2023, the number of primary care well-child visits increased across all racial and ethnic groups. However, Non-Hispanic White children still have a higher utilization of this service than Hispanic and Non-Hispanic Black children. Since 2020, the gap in primary care sick visits among the different racial and ethnic groups seems to have decreased in comparison with earlier years when Non-Hispnic Black and Hispanic children used this service less than White children. 

```{r plotting racial trends, code_folding="hide"}
#Plot utilization of each service by race/ethnicity
ggplot(race_data, aes(x = year, y = utilization, color = race)) +
  geom_line() +
  facet_wrap(~ category, scales = "fixed") +
  theme_minimal() +
  labs(title = "Healthcare Utilization Trends by Race/Ethnicity", x = "Year", y = "Utilization", color = "Race/Ethnicity")
```

#### How may changes to Medicaid eligibility requirements impact the services utilized? Is there evidence that these changes differ across demographic groups? Hypothesize potential reasons for these differences if so. 

Black and Hispanic children make up a majority of Medicaid enrolled children in the United States. Since Medicaid is an income-based need program, changes to Medicaid's eligibility system, particularly any changes to the qualifying income level, may disproportionately impact Black and Hispanic children. Decreasing the qualifying income level or imposing work-requirements like some states have, for example, would lead to less enrollees in Medicaid. If individuals that are enrolled under expanded Medicaid eligibility have that eligibility rolled back, it is likely that the trend observed since 2020 of increasing visits covered by Medicaid would reverse. 

The data show that Black and Hispanic children are less likely to go to preventative well-child visits or primary care visits when sick, which explains in part the higher ED utilization and higher inpatient days observed by these groups, as they may have more severe illness by the time they do seek care.

Overall, changes in Medicaid eligibility requirement would lead to a decline in preventative & routine care in a primary care environment for Hispanic and Black children, that have historically had lower PC utilization than White children, due to high out-of-pocket costs for uninsured children. Such delay in seeking care when sick, for example, will lead to an overrealiance on the ED and increase strains on inpatient care. 

###Part 2: Demographic trends among children who underwent surgery for congenital heart disease in NY state in 2022

*The code below shows the importing and preparation of data for linking.*

```{r problem 2: import & clean}
options(scipen = 999)  # Turn off scientific notation globally so data correctly imports from Excel sheet 

sheet2 <- readxl::read_excel("data.xlsx", sheet = "Sheet2") #import sheet 2

sheet2$tract <- as.numeric(sheet2$tract)  # Convert 'tract' column to numeric to facilitate join 

#import sheet 3
sheet3 =
  readxl::read_excel("data.xlsx", sheet = "Sheet3") |>
  janitor::clean_names(case = "snake") |>
  separate(geo_id, sep="S", into = c("geo_id", "tract")) |> #extract 'tract' from 'geo_id' variable for join 
  mutate(tract = as.numeric(tract)) #ensure tract is numeric as well 

 sheet3 |>
  rename(pop_6_m=b27003_003e, pop_18_m = b27003_006e, pop_6_f = b27003_031e, pop_18_f = b27003_034e) |>
  rename(public_6_m = b27003_004e, public_18_m = b27003_007e, public_6_f = b27003_032e, public_18_f = b27003_035e) |> #rename variables of interest
  select(-geo_id) -> sheet3 

sheet3 |> 
  select(tract, pop_6_m, pop_18_m,  pop_6_f, pop_18_f, public_6_m, 
         public_18_m, public_6_f, public_18_f) -> clean_sheet3
 
```

*The code below shows the linking of data in Sheets 2 and 3.*

```{r link data}
linked_data = 
  inner_join(sheet2,clean_sheet3, by=c("tract"))
```

#### Calculating the proportion of people ≤18 years old who are on public insurance for each patient’s census tract.

```{r }
linked_data |>
  mutate(total_pop = pop_6_m + pop_18_m + pop_6_f + pop_18_f) |>
  mutate(public_pop = public_6_m + public_18_m + public_6_f + public_18_f) |>
  mutate(proportion_public = public_pop / total_pop) 
```

```{r }
sum(is.na(clean_sheet3))
clean_sheet3[!complete.cases(clean_sheet3), ]
```

#### Patterns by public insurance and race/ethnicity

```{r patterns of public insurance coverage by race/ethnicity and public insurance}
linked_data |>
  group_by(race) |>
  summarize(n_obs=n()) |>
    arrange(desc(n_obs))

#list the census tracts by proportion of public insurance from highest to lowest. 
proportion_public_per_tract |>
  group_by(tract) |>
  slice_head(n = 1) |>
  arrange(desc(proportion_public)) 

#compare the mean proportion of children on public health insurance by racial group 
linked_data |>
  group_by(race) |>
  summarise(
    mean_public_ins = mean(proportion_public, na.rm = TRUE),
    median_public_ins = median(proportion_public, na.rm = TRUE),
    sd_public_ins = sd(proportion_public, na.rm = TRUE),
    count = n()
  )
```

```{r visualize }
library(ggplot2)

ggplot(linked_data, aes(x = race, y = proportion_public, fill = race)) +
  geom_boxplot() +
  labs(title = "Public Insurance Proportion by Race/Ethnicity",
       x = "Race/Ethnicity",
       y = "Proportion on Public Insurance") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(linked_data, aes(x = proportion_public)) +
  geom_histogram(binwidth = 0.1, fill = "blue", color = "black", alpha = 0.7) +
  facet_wrap(~ race) +
  labs(title = "Distribution of Public Insurance Proportion",
       x = "Proportion on Public Insurance",
       y = "Count") +
  theme_minimal()
```


To do:
Map
Table of top 10 census tracts
Patterms by public insurance and race/ethnicity (looking at mean proportion of public by race)
Some kind of significance analysis (?)