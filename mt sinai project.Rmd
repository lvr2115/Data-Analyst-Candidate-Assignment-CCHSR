
---
title: "<h1 style='margin-bottom: 10px; text-align: center;'>Examining Trends in Pediatric
  Healthcare Utilization</h1>"
author: "<p style='margin-bottom: 5px; text-align: center;'>Laura Robles-Torres</p>"
date: "<p style='margin-bottom: 30px; text-align: center;'>February 18, 2025</p>"
output:
  html_document:
    code_folding: hide
  pdf_document: default
subtitle: "<h3 style='margin-top: 5px; margin-bottom: 20px; text-align: center; font-style:
  italic;'>Data Analyst Candidate Assignment: CCHSR</h3>"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Part 1: Trends in utilization of various healthcare services among children between 2015 and 2023

*The code below includes initial library loading, data importing, and reshaping for analysis.*
```{r install packages, message=FALSE, warning=FALSE, code_folding="hide"}
library(tidyverse)
library(tidyr)
library(readxl)
library(dbplyr)
library(stringr)
library(ggplot2)
```

```{r import sheet 1, results='hide', code_folding="hide",  warning=FALSE}
#Import Sheet 1 data
utilization_data =
    readxl::read_excel("data.xlsx", sheet = "Sheet1")

head(utilization_data)
```

Between 2015 and 2023, several trends can be observed in healthcare utilization among children of varying racial/ethnic groups and insurance payers. The data analyzed capture the utilization of healthcare services, grouped by **insurance payers** and by **race/ethnicity**. Healthcare services are grouped in four different categories: 

- Primary Care Visits, well-child 
- Primary Care Visits, sick 
- Emergency Department Visits 
- Inpatient Days 

The insurance payers included are **Medicaid** and **Private insurance**. The races/ethnicities are **Non-Hispanic Black (NH Black)**, **Hispanic**, and **Non-Hispanic White (NH White)**. 

#### By insurance payer

```{r payer groups, code_folding="hide",  warning=FALSE}
#Clean data for payer group exploratory analysis 
payor_data = utilization_data |>
  mutate(
    payor = ifelse(category %in% c("Medicaid", "Private Insurance"), category, NA) 
  ) |> 
  fill(payor, .direction = "down") |> 
  filter(!category %in% c("Medicaid", "Private Insurance")) |> # Remove payer rows that are empty 
  slice(1:8) #Use only data reflecting utilization by payer

# Reshape data into long format
payor_data |>
  pivot_longer(cols = `2015`:`2023`, names_to = "year", values_to = "utilization") |>
  mutate(year = as.numeric(year)) |>
  select(year, payor, category, utilization) -> payor_data
```

Before 2020, utilization of all services except primary care well-child visits was similar between the two payer groups. While ED visits, primary care sick visits, and inpatient days remained comparable across payers, well-child visits were more frequently covered by private insurance than Medicaid until 2020. Beginning in 2020, Medicaid coverage increased across all four service types, while private insurance coverage remained relatively stable. The sharpest increase in Medicaid-covered services is among primary care well-child visits. 

```{r plotting payor trends,  warning=FALSE}
#Plot utilization of each service by payor
ggplot(payor_data, aes(x = year, y = utilization, color = payor)) +
  geom_line() +
  facet_wrap(~ category, scales = "fixed") +
  theme_minimal() +
  labs(title = "Healthcare Utilization Trends by Payor", x = "Year", y = "Utilization", color="Insurance Payer")
```

#### By race/ethnicity
```{r race/ethn groups, code_folding="hide", warning=FALSE}
#Clean data for racial/ethnic group exploratory analysis 
race_data = 
  utilization_data |>
  mutate(
    race = ifelse(category %in% c("Hispanic", "Non-Hispanic Black", "Non-Hispanic White"), category, NA)
  ) |> 
  fill(race, .direction = "down") |>  # Fill race downwards
  filter(!category %in% c("Hispanic", "Non-Hispanic Black", "Non-Hispanic White")) # Remove race rows that are empty

# Reshape data into long format
race_data |>
  pivot_longer(cols = `2015`:`2023`, names_to = "year", values_to = "utilization")|>
  mutate(year = as.numeric(year)) |> 
  filter(!is.na(utilization)) |> 
  filter(!is.na(race)) |> #Filter out missing values if any 
  slice_tail(n=126) -> race_data #Use only data reflecting utilization by race
```

Hispanic and NH Black children have higher overall utilization of ED visits compared to NH White children during this period, with Hispanic children specifically having significantly more ED visits. Starting in 2020, ED visits among both Hispanic and NH Black children slightly decreased. 

Inpatient days have increased slightly for all three groups between 2015 and 2023, with Hispanic and NH Black children consistently having higher inpatient days than NH White children.

From 2015 to 2023, primary care well-child visits increased across all racial and ethnic groups, but NH White children continued to have higher utilization than Hispanic and NH Black children. Notably, there was a significant increase in well-child visits among Hispanic and NH Black children starting in 2020. Additionally, the gap in primary care sick visits has narrowed since 2020, compared to earlier years when Hispanic and NH Black children used this service less frequently than NH White children.

```{r plotting racial trends, code_folding="hide",  warning=FALSE}
#Plot utilization of each service by race/ethnicity
ggplot(race_data, aes(x = year, y = utilization, color = race)) +
  geom_line() +
  facet_wrap(~ category, scales = "fixed") +
  theme_minimal() +
  labs(title = "Healthcare Utilization Trends by Race/Ethnicity", x = "Year", y = "Utilization", color = "Race/Ethnicity")
```

#### How may changes to Medicaid eligibility requirements impact the services utilized? Is there evidence that these changes differ across demographic groups? Hypothesize potential reasons for these differences if so. 

Changes to Medicaid eligibility, particularly those increasing income limits and expanding access, have likely contributed to shifts in healthcare utilization across these four service types. The ACA’s Medicaid expansion and increased Medicaid enrollment due to the COVID-19 pandemic have allowed more families, particularly those from low-income households, to access healthcare services that were previously out of reach. However, reductions in Medicaid eligibility, such as lowering income thresholds or introducing work requirements, would disproportionately impact Hispanic and NH Black children, who are more likely to come from low-income families and be uninsured. This could reverse the trend since 2020 of increasing Medicaid coverage, making it harder for these children to access primary care and preventive services.

NH Black and Hispanic children tend to use primary care services less frequently than their White peers, often seeking care only when health issues become more severe. As a result, these groups show higher rates of ED utilization and inpatient care. If Medicaid eligibility is reduced, this pattern would likely worsen, leading to greater reliance on emergency departments and increased strain on inpatient services.

### Part 2: Demographic trends among children who underwent surgery for congenital heart disease in NY state in 2022

*The code below shows the importing and preparation of data for linking.*

```{r problem 2: import & clean,  warning=FALSE}
options(scipen = 999)  # Turn off scientific notation globally so data correctly imports from Excel sheet 

sheet2 <- readxl::read_excel("data.xlsx", sheet = "Sheet2") #Import sheet 2 (patient data)

sheet2$tract <- as.numeric(sheet2$tract)  # Convert 'tract' column to numeric to facilitate join 

#import sheet 3
sheet3 <- readxl::read_excel("data.xlsx", sheet = "Sheet3") |>
          janitor::clean_names(case = "snake") |> 
          separate(geo_id, sep="S", into = c("geo_id", "tract")) |> #Extract 'tract' from 'geo_id' variable for join 
          mutate(tract = as.numeric(tract)) #Ensure tract is numeric as well 

 clean_sheet3 <- sheet3 |> #Rename variables of interest for ease
  rename(pop_6_m=b27003_003e, pop_18_m = b27003_006e, pop_6_f = b27003_031e, pop_18_f = b27003_034e) |>
  rename(public_6_m = b27003_004e, public_18_m = b27003_007e, public_6_f = b27003_032e, public_18_f = b27003_035e, pop_density = populationdensitypersquarem) |> 
  select(-geo_id)
 
 clean_sheet3 <-clean_sheet3 |> #Select only variables of interest 
    select(tract, pop_6_m, pop_18_m,  pop_6_f, pop_18_f, public_6_m, 
         public_18_m, public_6_f, public_18_f, pop_density) 
```

*The code below shows the linking of data in Sheets 2 and 3.*

```{r link data}
linked_data = 
  inner_join(sheet2,clean_sheet3, by=c("tract"))
```

#### Proportion of people ≤18 years old who are on public insurance for each patient’s census tract:

The proportion of people that are 18 or younger and are on public insurance was calculated for each census tract included in the data. The total of individuals meeting this criteria was calculated using data from the US Census and the American Community Survey 5-year estimates on the number of people on Public Insurance by sex and age in 2022. 

The number of males and females (18 years or younger) on public insurance in each census tract was divided by the total number of the number of males and females (18 years or younger) residing in that same census tract. 

*The table below is a sample to show final calculations.*

```{r, warning=FALSE}
linked_data |>
  mutate(total_pop = pop_6_m + pop_18_m + pop_6_f + pop_18_f) |>
  mutate(public_pop = public_6_m + public_18_m + public_6_f + public_18_f) |>
  mutate(proportion_public = public_pop / total_pop) -> proportion_public_per_tract

sample_proportion_public <- proportion_public_per_tract |>
  distinct(tract, .keep_all = TRUE) |>
  slice(1:10) |> 
  select(patid, sex, age,race,tract,total_pop,public_pop, proportion_public)

knitr::kable(sample_proportion_public)
```

```{r}
proportion_public_per_tract |> 
  filter(!is.na(pop_density) & !is.na(proportion_public)) |>  # Remove rows with NA or zero pop_density
  mutate(weighted_proportion = proportion_public * pop_density) |>  # Calculate weighted proportion
  group_by(race) |>  # Group by race/ethnicity
  summarise(
    weighted_mean_proportion = sum(weighted_proportion) / sum(pop_density),  # Weighted mean by race
    .groups = "drop"  # Drop grouping for a cleaner result
  )

```

```{r,  warning=FALSE, results='hide'}
sum(is.na(clean_sheet3))
clean_sheet3[!complete.cases(clean_sheet3), ]
```

#### Patterns by public insurance and race/ethnicity

##### Sample data grouped by race/ethnicity

```{r patterns of public insurance coverage by race/ethnicity and public insurance,  warning=FALSE}
#how many children of each racial/ethnic group are in our dataset?
linked_data |>
  group_by(race) |>
  summarize(n_obs=n()) |>
    arrange(desc(n_obs)) -> grouped_race #we have a pretty balanced sample

knitr::kable(grouped_race)
```

##### Do certain racial/ethnic groups tend to have higher proportions of public insurance?  

These are the top 25 census tracts with the highest proportion of people <18 years old on public insurance: 
```{r, results='hide', warning=FALSE}
proportion_public_per_tract |>
  group_by(tract) |>
  arrange(desc(proportion_public))
```

```{r, warning=FALSE}
proportion_public_table_unique <- proportion_public_per_tract |> 
  distinct(tract, .keep_all = TRUE) |>
  arrange(desc(proportion_public)) |>
  slice(1:25) |>
  select(patid, race, tract,proportion_public)

knitr::kable(proportion_public_table_unique)
```

**The mean proportion of public health insurance coverage is highest for Non-Hispanic Black children (65%), compared to Hispanic (35%) and White (27%) children.** 

```{r, warning=FALSE}
#compare the mean proportion of children on public health insurance by racial group 
proportion_public_per_tract|>
  group_by(race) |>
  summarise(
    mean_public_ins = mean(proportion_public, na.rm = TRUE),
    median_public_ins = median(proportion_public, na.rm = TRUE),
    sd_public_ins = sd(proportion_public, na.rm = TRUE),
    count = n()
  ) -> descriptive_statistics

knitr::kable(descriptive_statistics)
```

```{r visualize,  warning=FALSE}
library(ggplot2)

ggplot(proportion_public_per_tract, aes(x = race, y = proportion_public, fill = race)) +
  geom_boxplot() +
  labs(title = "Public Insurance Proportion by Race/Ethnicity",
       x = "Race/Ethnicity",
       y = "Proportion on Public Insurance") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

**NH Black children are more likely to reside in census tracts with a higher percentage of children on public insurance, while Hispanic and NH White children are more likely to live in census tracts with lower public insurance rates.**

A statistical test would be conducted to assess whether these differences in public health insurance proportions between racial/ethnic groups are statistically significant. 

To do:
Look into populationdensitypersquarem
Look into descriptive stats of age, sex, race/ethnicity table 
Revise report text (look at goals)
